console.log('This site was generated by Hugo.');

// Main JavaScript file for Cyberguard theme

// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    // Initialize theme toggle
    initThemeToggle();

    // Initialize mobile menu
    initMobileMenu();
    
    // Smooth scrolling for anchor links
    initSmoothScroll();
    
    // Publications toggle
    const viewToggle = document.querySelector('.view-toggle');
    if (viewToggle) {
        viewToggle.addEventListener('click', function(e) {
            e.preventDefault();
            const isShowingAll = this.getAttribute('data-showing-all') === 'true';
            const hiddenPublications = document.querySelectorAll('.hidden-publication');
            
            if (isShowingAll) {
                // Hide publications
                hiddenPublications.forEach(pub => {
                    pub.style.display = 'none';
                });
                this.setAttribute('data-showing-all', 'false');
                // Use the original text that was set by Hugo template
                // which already has the correct i18n translation
                const viewAllText = this.getAttribute('data-view-all-text');
                if (viewAllText) {
                    this.textContent = viewAllText;
                }
                
                // Scroll to publications section
                document.getElementById('publications').scrollIntoView({ behavior: 'smooth' });
            } else {
                // Show all publications
                hiddenPublications.forEach(pub => {
                    pub.style.display = 'block';
                });
                this.setAttribute('data-showing-all', 'true');
                // Use the hide text that was set by Hugo template
                const hideText = this.getAttribute('data-hide-text');
                if (hideText) {
                    this.textContent = hideText;
                }
            }
        });
    }
    
    // Initialize animations
    initAnimations();
    
    // Initialize portfolio carousel
    initPortfolioCarousel();

    // Track language switches for analytics
    const langButtons = document.querySelectorAll('.btn-lang');
    langButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Get the language from the URL
            const href = this.getAttribute('href');
            const lang = href.includes('/ru/') ? 'ru' : 'en';
            
            // Set the cookie for future visits
            setLanguagePreference(lang);
        });
    });
});

/**
 * Theme toggle
 */
function initThemeToggle() {
    var btn = document.querySelector('.theme-toggle-btn');
    if (!btn) return;

    btn.addEventListener('click', function() {
        var current = document.documentElement.getAttribute('data-theme');
        var next = current === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
    });

    matchMedia('(prefers-color-scheme:dark)').addEventListener('change', function(e) {
        if (localStorage.getItem('theme')) return;
        document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
    });
}

/**
 * Mobile menu initialization
 */
function initMobileMenu() {
    const mobileMenuToggle = document.querySelector('.mobile-menu-toggle');
    
    if (mobileMenuToggle) {
        mobileMenuToggle.addEventListener('click', function() {
            document.body.classList.toggle('menu-open');
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.main-nav') && !e.target.closest('.mobile-menu-toggle') && document.body.classList.contains('menu-open')) {
                document.body.classList.remove('menu-open');
            }
        });
        
        // Close menu when clicking on navigation links
        const navLinks = document.querySelectorAll('.main-nav a');
        navLinks.forEach(link => {
            link.addEventListener('click', function() {
                document.body.classList.remove('menu-open');
            });
        });
    }
}

/**
 * Smooth scrolling for anchor links
 */
function initSmoothScroll() {
    const anchorLinks = document.querySelectorAll('a[href^="#"]:not([href="#"])');
    
    anchorLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            const targetId = this.getAttribute('href');
            const targetElement = document.querySelector(targetId);
            
            if (!targetElement) return;
            
            const headerOffset = document.querySelector('.site-header').offsetHeight;
            const elementPosition = targetElement.getBoundingClientRect().top;
            const offsetPosition = elementPosition + window.pageYOffset - headerOffset;
            
            window.scrollTo({
                top: offsetPosition,
                behavior: 'smooth'
            });
        });
    });
}

/**
 * Initialize animations for content elements
 */
function initAnimations() {
    const animatedElements = document.querySelectorAll('.animate-on-scroll');
    
    const observerOptions = {
        root: null,
        rootMargin: '0px',
        threshold: 0.15
    };
    
    const observer = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('animated');
                observer.unobserve(entry.target);
            }
        });
    }, observerOptions);
    
    animatedElements.forEach(element => {
        observer.observe(element);
    });
}

/**
 * Set cookie helper function
 */
function setCookie(name, value, days) {
    let expires = '';
    if (days) {
        const date = new Date();
        date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
        expires = '; expires=' + date.toUTCString();
    }
    document.cookie = name + '=' + value + expires + '; path=/; SameSite=Strict';
}

/**
 * Get cookie helper function
 */
function getCookie(name) {
    const nameEQ = name + '=';
    const ca = document.cookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i];
        while (c.charAt(0) === ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
    }
    return null;
}

/**
 * Language switcher functions
 */
function setLanguagePreference(lang) {
    setCookie('preferred_lang', lang, 365);
}

/**
 * Initialize portfolio carousel
 */
function initPortfolioCarousel() {
    const portfolioGrid = document.querySelector('.portfolio-grid');
    if (!portfolioGrid) return;
    
    const originalCards = Array.from(portfolioGrid.querySelectorAll('.portfolio-card'));
    if (originalCards.length === 0) return;
    
    var styleEl = null;

    function removeDuplicates() {
        var allCards = portfolioGrid.querySelectorAll('.portfolio-card');
        allCards.forEach(function(card, i) {
            if (i >= originalCards.length) card.remove();
        });
    }

    function checkAndEnableScrolling() {
        portfolioGrid.classList.remove('is-scrolling');
        portfolioGrid.style.animation = 'none';
        removeDuplicates();

        var needsScrolling = portfolioGrid.scrollWidth > portfolioGrid.clientWidth;

        if (needsScrolling && originalCards.length > 1) {
            portfolioGrid.classList.add('is-scrolling');

            var containerWidth = portfolioGrid.parentElement.offsetWidth;
            var gap = parseInt(window.getComputedStyle(portfolioGrid).gap) || 32;
            var estimatedSetWidth = originalCards.length * (320 + gap);

            var setsNeeded = Math.ceil((containerWidth + estimatedSetWidth) / estimatedSetWidth) + 1;
            for (var s = 0; s < setsNeeded; s++) {
                originalCards.forEach(function(card) {
                    portfolioGrid.appendChild(card.cloneNode(true));
                });
            }

            var oneSetWidth = portfolioGrid.children[originalCards.length].offsetLeft - portfolioGrid.children[0].offsetLeft;

            if (styleEl) styleEl.remove();
            styleEl = document.createElement('style');
            styleEl.textContent =
                '@keyframes scrollPortfolio{' +
                'from{transform:translate3d(0,0,0)}' +
                'to{transform:translate3d(-' + oneSetWidth + 'px,0,0)}' +
                '}';
            document.head.appendChild(styleEl);

            var speed = 40;
            var duration = oneSetWidth / speed;
            portfolioGrid.style.animation = 'scrollPortfolio ' + duration + 's linear infinite';

            portfolioGrid.addEventListener('mouseenter', pauseAnimation);
            portfolioGrid.addEventListener('mouseleave', resumeAnimation);
        } else {
            portfolioGrid.removeEventListener('mouseenter', pauseAnimation);
            portfolioGrid.removeEventListener('mouseleave', resumeAnimation);
        }
    }
    
    function pauseAnimation() {
        this.style.animationPlayState = 'paused';
    }
    
    function resumeAnimation() {
        this.style.animationPlayState = 'running';
    }
    
    // Initial check
    checkAndEnableScrolling();
    
    // Recheck on window resize
    let resizeTimer;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(checkAndEnableScrolling, 250);
    });
}
